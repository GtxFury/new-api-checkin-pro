name: linux.do 自动阅读点赞
on:
  schedule:
    # 下午一点执行
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  linuxdo-read-like:
    permissions:
      contents: read
    runs-on: windows-2025
    environment: production
    env:
      PYTHONIOENCODING: utf-8
      LINUXDO_FEED: latest
      LINUXDO_TOPICS_PER_RUN: '10'
      LINUXDO_MIN_READ_SECONDS: '25'
      LINUXDO_MAX_READ_SECONDS: '90'
      LINUXDO_MAX_LIKES_PER_TOPIC: '2'
      # 默认跳过置顶主题（设为 0 可关闭）
      LINUXDO_SKIP_PINNED: '1'
      # 不建议在 GitHub Hosted Runner 上尝试自动解 Turnstile；通常需要人工/自建 runner 才稳定
      LINUXDO_TRY_TURNSTILE_SOLVER: '0'
      # 多账号之间的延迟（秒），避免触发 429 限流
      LINUXDO_ACCOUNT_DELAY: '30'
      # 阅读轮数（每个账号执行几轮阅读，默认 1 轮）
      LINUXDO_READ_ROUNDS: '3'
      # 轮次之间的延迟（秒）
      LINUXDO_ROUND_DELAY: '60'
    steps:
      - name: set beijing timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneWindows: 'China Standard Time'

      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v3
        with:
          version: 'latest'

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 缓存 UV 依赖
        uses: actions/cache@v4
        id: uv-cache
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: 安装依赖
        if: steps.uv-cache.outputs.cache-hit != 'true'
        run: |
          echo "缓存未命中，开始安装项目依赖..."
          uv sync
          echo "✅ 环境初始化完成"

      - name: 安装 Playwright 浏览器依赖
        run: |
          echo "安装 Playwright 浏览器依赖..."
          uv run python -m playwright install
          echo "✅ Playwright 浏览器依赖安装完成"

      - name: 获取 Camoufox 版本
        id: camoufox-version
        run: |
          $version = uv run python -c "import importlib.metadata; print(importlib.metadata.version('camoufox'))"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Camoufox version: $version"

      - name: 缓存 Camoufox 浏览器
        uses: actions/cache@v4
        id: camoufox-cache
        with:
          path: ~\AppData\Local\camoufox
          key: ${{ runner.os }}-camoufox-${{ steps.camoufox-version.outputs.version }}
          restore-keys: |
            ${{ runner.os }}-camoufox-

      - name: 安装 Camoufox 浏览器
        if: steps.camoufox-cache.outputs.cache-hit != 'true'
        run: |
          echo "缓存未命中，开始下载 Camoufox 浏览器..."
          uv run camoufox fetch
          echo "✅ Camoufox 浏览器安装完成"

      - name: 恢复 linux.do 登录状态/阅读状态缓存
        uses: actions/cache/restore@v4
        with:
          path: |
            storage-states
          key: storage-state-${{ hashFiles('storage-states/*.json') }}
          restore-keys: |
            storage-state-

      - name: 执行自动阅读点赞
        env:
          # Linux.do 专用账号配置（推荐，格式：[{"name": "账号1", "username": "user1", "password": "pass1"}, ...]）
          LINUXDO_ACCOUNTS: ${{ secrets.LINUXDO_ACCOUNTS }}
          # 兼容旧配置：如果 LINUXDO_ACCOUNTS 未设置，会回退到 ACCOUNTS 中的 linux.do 配置
          ACCOUNTS: ${{ secrets.ACCOUNTS }}
          DINGDING_WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          CUSTOM_SMTP_SERVER: ${{ secrets.CUSTOM_SMTP_SERVER }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          SERVERPUSHKEY: ${{ secrets.SERVERPUSHKEY }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          WEIXIN_WEBHOOK: ${{ secrets.WEIXIN_WEBHOOK }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          uv run python -u linuxdo_read_like.py

      - name: 保存 linux.do 登录状态/阅读状态缓存
        if: hashFiles('storage-states/*.json') != ''
        uses: actions/cache/save@v4
        with:
          path: |
            storage-states
          key: storage-state-${{ hashFiles('storage-states/*.json') }}

      - name: 保存日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linuxdo-artifacts-${{ github.run_number }}
          path: |
            logs/
            screenshots/
            storage-states/
          if-no-files-found: ignore
          retention-days: 7
