name: æ¸…ç† Actions ç¼“å­˜

on:
  workflow_dispatch:
    inputs:
      cache_prefix:
        description: 'è¦æ¸…ç†çš„ç¼“å­˜å‰ç¼€ï¼ˆç•™ç©ºæ¸…ç†æ‰€æœ‰ï¼‰'
        required: false
        default: ''
        type: string
      keep_latest:
        description: 'æ¯ä¸ªå‰ç¼€ä¿ç•™æœ€æ–°çš„å‡ ä¸ªç¼“å­˜'
        required: false
        default: '1'
        type: string
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸å®é™…åˆ é™¤'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: æ¸…ç†ç¼“å­˜
        uses: actions/github-script@v7
        with:
          script: |
            const cachePrefix = '${{ inputs.cache_prefix }}';
            const keepLatest = parseInt('${{ inputs.keep_latest }}') || 1;
            const dryRun = '${{ inputs.dry_run }}' === 'true';

            console.log(`ğŸ”§ é…ç½®:`);
            console.log(`   ç¼“å­˜å‰ç¼€: ${cachePrefix || '(æ‰€æœ‰)'}`);
            console.log(`   ä¿ç•™æ•°é‡: ${keepLatest}`);
            console.log(`   é¢„è§ˆæ¨¡å¼: ${dryRun}`);
            console.log('');

            // è·å–æ‰€æœ‰ç¼“å­˜
            const caches = await github.paginate(
              github.rest.actions.getActionsCacheList,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );

            console.log(`ğŸ“¦ æ‰¾åˆ° ${caches.length} ä¸ªç¼“å­˜`);

            if (caches.length === 0) {
              console.log('âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„ç¼“å­˜');
              return;
            }

            // æŒ‰å‰ç¼€åˆ†ç»„
            const groups = {};
            for (const cache of caches) {
              // å¦‚æœæŒ‡å®šäº†å‰ç¼€ï¼Œåªå¤„ç†åŒ¹é…çš„ç¼“å­˜
              if (cachePrefix && !cache.key.startsWith(cachePrefix)) {
                continue;
              }

              // æå–å‰ç¼€ï¼ˆç¬¬ä¸€ä¸ª - ä¹‹å‰çš„éƒ¨åˆ†ï¼Œæˆ–æ•´ä¸ª keyï¼‰
              const prefix = cache.key.split('-').slice(0, 2).join('-');
              if (!groups[prefix]) {
                groups[prefix] = [];
              }
              groups[prefix].push(cache);
            }

            // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            for (const prefix in groups) {
              groups[prefix].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
              );
            }

            // ç»Ÿè®¡
            let totalDeleted = 0;
            let totalSize = 0;

            console.log('');
            console.log('ğŸ“‹ ç¼“å­˜åˆ†ç»„:');

            for (const [prefix, cacheList] of Object.entries(groups)) {
              console.log(`\nğŸ·ï¸  ${prefix} (${cacheList.length} ä¸ª)`);

              for (let i = 0; i < cacheList.length; i++) {
                const cache = cacheList[i];
                const sizeKB = (cache.size_in_bytes / 1024).toFixed(1);
                const createdAt = new Date(cache.created_at).toLocaleString('zh-CN');
                const willDelete = i >= keepLatest;
                const status = willDelete ? 'ğŸ—‘ï¸' : 'âœ…';

                console.log(`   ${status} ${cache.key}`);
                console.log(`      å¤§å°: ${sizeKB} KB | åˆ›å»º: ${createdAt}`);

                if (willDelete) {
                  totalDeleted++;
                  totalSize += cache.size_in_bytes;

                  if (!dryRun) {
                    try {
                      await github.rest.actions.deleteActionsCacheById({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        cache_id: cache.id
                      });
                      console.log(`      âœ… å·²åˆ é™¤`);
                    } catch (error) {
                      console.log(`      âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
                    }
                  }
                }
              }
            }

            console.log('');
            console.log('ğŸ“Š ç»Ÿè®¡:');
            console.log(`   ${dryRun ? 'å°†åˆ é™¤' : 'å·²åˆ é™¤'}: ${totalDeleted} ä¸ªç¼“å­˜`);
            console.log(`   é‡Šæ”¾ç©ºé—´: ${(totalSize / 1024 / 1024).toFixed(2)} MB`);
